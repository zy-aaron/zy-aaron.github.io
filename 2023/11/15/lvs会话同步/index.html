<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zy-aaron.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="内核版本：5.10 目录[TOC] 数据组成开启会话同步时用户态向内核态发送的数据通过setsockopt，用户发送了一个ip_vs_daemon_kern结构的数据，这个结构主要包括当前的主备状态、组播网卡和syncid。下面是该结构的定义： 12345struct ip_vs_daemon_kern &amp;#123;	int			state; &#x2F;* 主机或备机 *&#x2F;	char			mcast_if">
<meta property="og:type" content="article">
<meta property="og:title" content="lvs会话同步">
<meta property="og:url" content="https://zy-aaron.github.io/2023/11/15/lvs%E4%BC%9A%E8%AF%9D%E5%90%8C%E6%AD%A5/index.html">
<meta property="og:site_name" content="赵耀的博客">
<meta property="og:description" content="内核版本：5.10 目录[TOC] 数据组成开启会话同步时用户态向内核态发送的数据通过setsockopt，用户发送了一个ip_vs_daemon_kern结构的数据，这个结构主要包括当前的主备状态、组播网卡和syncid。下面是该结构的定义： 12345struct ip_vs_daemon_kern &amp;#123;	int			state; &#x2F;* 主机或备机 *&#x2F;	char			mcast_if">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-15T05:19:47.000Z">
<meta property="article:modified_time" content="2024-09-01T05:39:22.715Z">
<meta property="article:author" content="Aaron Zhao">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="lvs">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zy-aaron.github.io/2023/11/15/lvs%E4%BC%9A%E8%AF%9D%E5%90%8C%E6%AD%A5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zy-aaron.github.io/2023/11/15/lvs%E4%BC%9A%E8%AF%9D%E5%90%8C%E6%AD%A5/","path":"2023/11/15/lvs会话同步/","title":"lvs会话同步"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>lvs会话同步 | 赵耀的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">赵耀的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%84%E6%88%90"><span class="nav-number">2.</span> <span class="nav-text">数据组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E4%BC%9A%E8%AF%9D%E5%90%8C%E6%AD%A5%E6%97%B6%E7%94%A8%E6%88%B7%E6%80%81%E5%90%91%E5%86%85%E6%A0%B8%E6%80%81%E5%8F%91%E9%80%81%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.</span> <span class="nav-text">开启会话同步时用户态向内核态发送的数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%A4%87%E5%90%8C%E6%AD%A5%E6%97%B6%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%84%E6%88%90"><span class="nav-number">2.2.</span> <span class="nav-text">主备同步时的数据组成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">整体调用流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E4%BC%9A%E8%AF%9D%E5%90%8C%E6%AD%A5%E5%8A%9F%E8%83%BD%E5%90%8E%E5%86%85%E6%A0%B8%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.1.</span> <span class="nav-text">开启会话同步功能后内核调用流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%A4%87%E6%9C%BA%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E6%97%B6%E7%9A%84%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">主备机同步数据时的调用流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">代码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E4%B8%8E%E5%86%85%E6%A0%B8%E6%80%81%E4%BA%A4%E4%BA%92%E9%83%A8%E5%88%86"><span class="nav-number">4.1.</span> <span class="nav-text">用户态与内核态交互部分</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#do-ip-vs-set-ctl"><span class="nav-number">4.1.1.</span> <span class="nav-text">do_ip_vs_set_ctl</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%A4%87%E6%9C%BA%E5%90%8C%E6%AD%A5%E9%83%A8%E5%88%86"><span class="nav-number">4.2.</span> <span class="nav-text">主备机同步部分</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#start-sync-thread"><span class="nav-number">4.2.1.</span> <span class="nav-text">start_sync_thread</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ip-vs-sync-conn"><span class="nav-number">4.2.2.</span> <span class="nav-text">ip_vs_sync_conn</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sync-thread-master"><span class="nav-number">4.2.3.</span> <span class="nav-text">sync_thread_master</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sync-thread-backup"><span class="nav-number">4.2.4.</span> <span class="nav-text">sync_thread_backup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ip-vs-process-message"><span class="nav-number">4.2.5.</span> <span class="nav-text">ip_vs_process_message</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ip-vs-proc-conn"><span class="nav-number">4.2.6.</span> <span class="nav-text">ip_vs_proc_conn</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Aaron Zhao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="mailto:1946697015@qq.com" title="E-Mail → mailto:1946697015@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zy-aaron.github.io/2023/11/15/lvs%E4%BC%9A%E8%AF%9D%E5%90%8C%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Aaron Zhao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="赵耀的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="lvs会话同步 | 赵耀的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          lvs会话同步
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-15 13:19:47" itemprop="dateCreated datePublished" datetime="2023-11-15T13:19:47+08:00">2023-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-09-01 13:39:22" itemprop="dateModified" datetime="2024-09-01T13:39:22+08:00">2024-09-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">Linux内核</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>内核版本：5.10</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>[TOC]</p>
<h2 id="数据组成"><a href="#数据组成" class="headerlink" title="数据组成"></a>数据组成</h2><h3 id="开启会话同步时用户态向内核态发送的数据"><a href="#开启会话同步时用户态向内核态发送的数据" class="headerlink" title="开启会话同步时用户态向内核态发送的数据"></a>开启会话同步时用户态向内核态发送的数据</h3><p>通过setsockopt，用户发送了一个<code>ip_vs_daemon_kern</code>结构的数据，这个结构主要包括当前的主备状态、组播网卡和syncid。<br>下面是该结构的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_daemon_kern</span> &#123;</span></span><br><span class="line">	<span class="type">int</span>			state; <span class="comment">/* 主机或备机 */</span></span><br><span class="line">	<span class="type">char</span>			mcast_ifn[IP_VS_IFNAME_MAXLEN]; <span class="comment">/* 组播接口名 */</span></span><br><span class="line">	<span class="type">int</span>			syncid; <span class="comment">/* syncid名，仅当主备机syncid相同时备机才会同步主机的连接表信息 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="主备同步时的数据组成"><a href="#主备同步时的数据组成" class="headerlink" title="主备同步时的数据组成"></a>主备同步时的数据组成</h3><p>在主备同步时，主机发送的数据主要由两部分构成，下面是主机（master）发送的buffer的组成：</p>
<p><strong>| ip_vs_sync_mesg | ip_vs_sync_conn |</strong></p>
<p>下面是这两个结构体的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_mesg</span> &#123;</span></span><br><span class="line">	__u8			reserved;	<span class="comment">/* 原先的连接数，现在该项必须为0 */</span></span><br><span class="line">	__u8			syncid;		<span class="comment">/* syncid信息，备机根据syncid判断是否同步主机的连接表 */</span></span><br><span class="line">	__be16			size;		<span class="comment">/* 要发送的数据大小，具体包括sizeof(struct ip_vs_sync_mesg) + sizeof(struct ip_vs_sync_v4) + 其他 */</span></span><br><span class="line">	__u8			nr_conns;	<span class="comment">/* 需要同步的连接数，初始为0 */</span></span><br><span class="line">	__s8			version;	<span class="comment">/* 同步协议版本，默认为1 */</span></span><br><span class="line">	__u16			spare;		<span class="comment">/* 从代码里看spare恒为0 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">ip_vs_sync_conn</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_v4</span>	<span class="title">v4</span>;</span>	<span class="comment">/* ipv4版本 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_v6</span>	<span class="title">v6</span>;</span>	<span class="comment">/* ipv6版本 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_v4</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 这里就是连接表内每条连接的信息，</span></span><br><span class="line"><span class="comment">	备机依据这些信息在本地建立和主机一样的连接表 */</span></span><br><span class="line">	__u8			type;</span><br><span class="line">	__u8			protocol;</span><br><span class="line">	__be16			ver_size;</span><br><span class="line">	__be32			flags;</span><br><span class="line">	__be16			state;</span><br><span class="line">	__be16			cport;</span><br><span class="line">	__be16			vport;</span><br><span class="line">	__be16			dport;</span><br><span class="line">	__be32			fwmark;</span><br><span class="line">	__be32			timeout;</span><br><span class="line">	__be32			caddr;</span><br><span class="line">	__be32			vaddr;</span><br><span class="line">	__be32			daddr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="整体调用流程"><a href="#整体调用流程" class="headerlink" title="整体调用流程"></a>整体调用流程</h2><h3 id="开启会话同步功能后内核调用流程"><a href="#开启会话同步功能后内核调用流程" class="headerlink" title="开启会话同步功能后内核调用流程"></a>开启会话同步功能后内核调用流程</h3><ol>
<li>首先，ipvsadm或keepalived通过类似<code>setsockopt(sockfd, IPPROTO_IP, IP_VS_SO_SET_STARTDAEMON,(char *)&amp;dmk, sizeof(dmk))</code>和内核通信</li>
<li>内核在<code>nf_setsockopt</code>函数中调用<code>ops-&gt;set</code>方法，该方法被注册为<code>do_ip_vs_set_ctl</code></li>
<li>内核调用<code>do_ip_vs_set_ctl</code>方法，根据传递的optname <code>IP_VS_SO_SET_STARTDAEMON</code>进而调用<code>start_sync_thread</code>方法</li>
<li>在<code>start_sync_thread</code>方法中，内核根据主备机身份的不同设置线程启动函数为<code>sync_thread_master</code>或<code>sync_thread_backup</code>，并设置发送或接受数据的socket，最后通过<code>kthread_run</code>创建并启动线程</li>
</ol>
<h3 id="主备机同步数据时的调用流程"><a href="#主备机同步数据时的调用流程" class="headerlink" title="主备机同步数据时的调用流程"></a>主备机同步数据时的调用流程</h3><ol>
<li>主机向备机发送同步数据时，包会依次经过<code>NF_INET_LOCAL_OUT</code>上挂载的函数，对于ipvs这些函数按优先级分别为<code>ip_vs_local_reply4</code>和<code>ip_vs_local_request4</code></li>
<li>在<code>ip_vs_local_request4-&gt;ip_vs_in</code>中，会判断当前是否为开启了会话同步的主机，<code>if (ipvs-&gt;sync_state &amp; IP_VS_STATE_MASTER)</code>，如果满足条件则会通过<code>ip_vs_sync_conn</code>用于生成会话同步数据</li>
<li>仅在有流量请求到达主机时，主机才会调用<code>ip_vs_sync_conn</code>用于同步数据，<code>ip_vs_sync_conn</code>主要用于拼装主机需要向备机发送的同步数据，当流量请求较大时，同步的数据会被放到队列内，后续会调用<code>wake_up_process</code>唤醒主机同步线程用于发送队列内的同步数据</li>
<li>主机同步线程被唤醒后，<code>sync_thread_master</code>会从队列中不断取出同步数据并通过<code>ip_vs_send_sync_msg</code>向备机发送数据</li>
<li>对于备机，备机线程<code>sync_thread_backup</code>在收到主机传递的同步数据后，会经过<code>ip_vs_process_message</code>验证收到的同步数据，并在<code>ip_vs_proc_sync_conn-&gt;ip_vs_proc_conn</code>依据传递的flag、ip、端口等字段在本地更新或建立连接，同时将该连接放入本地lvs连接表内</li>
</ol>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="用户态与内核态交互部分"><a href="#用户态与内核态交互部分" class="headerlink" title="用户态与内核态交互部分"></a>用户态与内核态交互部分</h3><h4 id="do-ip-vs-set-ctl"><a href="#do-ip-vs-set-ctl" class="headerlink" title="do_ip_vs_set_ctl"></a>do_ip_vs_set_ctl</h4><p>这是ipvs和用户态应用交互的核心函数，用户态应用调用<code>setsockopt</code>后会调用这个函数，为了突出重点，这里仅保留了内核处理会话同步部分的代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">do_ip_vs_set_ctl</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> cmd, <span class="type">sockptr_t</span> ptr, <span class="type">unsigned</span> <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(sk);</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> arg[MAX_SET_ARGLEN];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netns_ipvs</span> *<span class="title">ipvs</span> =</span> net_ipvs(net);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 确认用户有CAP_NET_ADMIN权限 */</span></span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 基本校验 */</span></span><br><span class="line">	<span class="keyword">if</span> (cmd &lt; IP_VS_BASE_CTL || cmd &gt; IP_VS_SO_SET_MAX)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (len != set_arglen[CMDID(cmd)]) &#123;</span><br><span class="line">		IP_VS_DBG(<span class="number">1</span>, <span class="string">&quot;set_ctl: len %u != %u\n&quot;</span>,</span><br><span class="line">			  len, set_arglen[CMDID(cmd)]);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 将用户态发送的数据拷贝到arg，这里的arg就是我们在用户态发送的ip_vs_daemon_kern结构 */</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_sockptr(arg, ptr, len) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cmd == IP_VS_SO_SET_STARTDAEMON ||</span><br><span class="line">	    cmd == IP_VS_SO_SET_STOPDAEMON) &#123;</span><br><span class="line">		<span class="comment">/* 如果是要开启或关闭会话同步功能 */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 将arg转为ip_vs_daemon_user，该结构定义和ip_vs_daemon_kern完全一致 */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_daemon_user</span> *<span class="title">dm</span> =</span> (<span class="keyword">struct</span> ip_vs_daemon_user *)arg;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cmd == IP_VS_SO_SET_STARTDAEMON) &#123;</span><br><span class="line">			<span class="comment">/* 开启会话同步 */</span></span><br><span class="line"></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">ipvs_sync_daemon_cfg</span> <span class="title">cfg</span>;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 将组播的网卡、syncid等信息设置到cfg内 */</span></span><br><span class="line">			<span class="built_in">memset</span>(&amp;cfg, <span class="number">0</span>, <span class="keyword">sizeof</span>(cfg));</span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">			<span class="keyword">if</span> (strscpy(cfg.mcast_ifn, dm-&gt;mcast_ifn,</span><br><span class="line">				    <span class="keyword">sizeof</span>(cfg.mcast_ifn)) &lt;= <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			cfg.syncid = dm-&gt;syncid;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 启动线程，执行同步的相关操作 */</span></span><br><span class="line">			ret = start_sync_thread(ipvs, &amp;cfg, dm-&gt;state);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* 关闭会话同步 */</span></span><br><span class="line"></span><br><span class="line">			ret = stop_sync_thread(ipvs, dm-&gt;state);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 这里去除了处理其他ipvs操作相关的代码 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="主备机同步部分"><a href="#主备机同步部分" class="headerlink" title="主备机同步部分"></a>主备机同步部分</h3><h4 id="start-sync-thread"><a href="#start-sync-thread" class="headerlink" title="start_sync_thread"></a>start_sync_thread</h4><p>在开启会话同步后，ipvs根据主备机身份的不同设置参数，通过创建新的线程处理同步数据的发送或接收</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">start_sync_thread</span><span class="params">(<span class="keyword">struct</span> netns_ipvs *ipvs, <span class="keyword">struct</span> ipvs_sync_daemon_cfg *c,</span></span><br><span class="line"><span class="params">		      <span class="type">int</span> state)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_thread_data</span> *<span class="title">ti</span> =</span> <span class="literal">NULL</span>, *tinfo;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="type">char</span> *name;</span><br><span class="line">	<span class="type">int</span> (*threadfn)(<span class="type">void</span> *data);</span><br><span class="line">	<span class="type">int</span> id = <span class="number">0</span>, count, hlen;</span><br><span class="line">	<span class="type">int</span> result = -ENOMEM;</span><br><span class="line">	u16 mtu, min_mtu;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 增加模块使用计数 */</span></span><br><span class="line">	<span class="keyword">if</span> (!ip_vs_use_count_inc())</span><br><span class="line">		<span class="keyword">return</span> -ENOPROTOOPT;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 获取锁 */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		rtnl_lock();</span><br><span class="line">		<span class="keyword">if</span> (mutex_trylock(&amp;ipvs-&gt;sync_mutex))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		rtnl_unlock();</span><br><span class="line">		mutex_lock(&amp;ipvs-&gt;sync_mutex);</span><br><span class="line">		<span class="keyword">if</span> (rtnl_trylock())</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		mutex_unlock(&amp;ipvs-&gt;sync_mutex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* sync_ports全局配置控制了开启的会话同步线程数，默认为1，首个线程其socket端口为8848，</span></span><br><span class="line"><span class="comment">	后面开启的线程端口以8848为基准依次+1 */</span></span><br><span class="line">	<span class="keyword">if</span> (!ipvs-&gt;sync_state) &#123;</span><br><span class="line">		<span class="comment">/* 第一次，尚未设置sync_state */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* count决定了我们开启的用于会话同步的线程数量 */</span></span><br><span class="line">		count = clamp(sysctl_sync_ports(ipvs), <span class="number">1</span>, IPVS_SYNC_PORTS_MAX);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 掩码用于主机选取一个线程id用于发送当前的同步数据到备机 */</span></span><br><span class="line">		ipvs-&gt;threads_mask = count - <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		count = ipvs-&gt;threads_mask + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 这里设置协议族AF_INET，ip配置为224.0.0.81 */</span></span><br><span class="line">	<span class="keyword">if</span> (c-&gt;mcast_af == AF_UNSPEC) &#123;</span><br><span class="line">		c-&gt;mcast_af = AF_INET;</span><br><span class="line">		c-&gt;mcast_group.ip = cpu_to_be32(IP_VS_SYNC_GROUP);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置多播端口为8848，ttl为1，这里的端口后续会加上线程id，如果设置</span></span><br><span class="line"><span class="comment">	仅开启一个线程用于会话同步，则id默认为0，端口为8848 */</span></span><br><span class="line">	<span class="keyword">if</span> (!c-&gt;mcast_port)</span><br><span class="line">		c-&gt;mcast_port = IP_VS_SYNC_PORT;</span><br><span class="line">	<span class="keyword">if</span> (!c-&gt;mcast_ttl)</span><br><span class="line">		c-&gt;mcast_ttl = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 根据用户态传递的接口名获取网卡 */</span></span><br><span class="line">	dev = __dev_get_by_name(ipvs-&gt;net, c-&gt;mcast_ifn);</span><br><span class="line">	<span class="keyword">if</span> (!dev) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;Unknown mcast interface: %s\n&quot;</span>, c-&gt;mcast_ifn);</span><br><span class="line">		result = -ENODEV;</span><br><span class="line">		<span class="keyword">goto</span> out_early;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置首部长度、mtu、min_mtu */</span></span><br><span class="line">	hlen = (AF_INET6 == c-&gt;mcast_af) ?</span><br><span class="line">	       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ipv6hdr) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> udphdr) :</span><br><span class="line">	       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iphdr) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> udphdr);</span><br><span class="line">	mtu = (state == IP_VS_STATE_BACKUP) ?</span><br><span class="line">		  clamp(dev-&gt;mtu, <span class="number">1500U</span>, <span class="number">65535U</span>) : <span class="number">1500U</span>;</span><br><span class="line">	min_mtu = (state == IP_VS_STATE_BACKUP) ? <span class="number">1024</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置同步数据的最大长度 */</span></span><br><span class="line">	<span class="keyword">if</span> (c-&gt;sync_maxlen)</span><br><span class="line">		c-&gt;sync_maxlen = <span class="type">clamp_t</span>(<span class="type">unsigned</span> <span class="type">int</span>,</span><br><span class="line">					 c-&gt;sync_maxlen, min_mtu,</span><br><span class="line">					 <span class="number">65535</span> - hlen);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="comment">/* 第一次设置sync_maxlen */</span></span><br><span class="line">		c-&gt;sync_maxlen = mtu - hlen;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (state == IP_VS_STATE_MASTER) &#123;</span><br><span class="line">		<span class="comment">/* 主机，负责发送同步数据 */</span></span><br><span class="line"></span><br><span class="line">		result = -EEXIST;</span><br><span class="line">		<span class="keyword">if</span> (ipvs-&gt;ms)</span><br><span class="line">			<span class="keyword">goto</span> out_early;</span><br><span class="line"></span><br><span class="line">		ipvs-&gt;mcfg = *c;</span><br><span class="line">		name = <span class="string">&quot;ipvs-m:%d:%d&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 设置线程调用函数 */</span></span><br><span class="line">		threadfn = sync_thread_master;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == IP_VS_STATE_BACKUP) &#123;</span><br><span class="line">		<span class="comment">/* 备机，负责接收同步数据 */</span></span><br><span class="line"></span><br><span class="line">		result = -EEXIST;</span><br><span class="line">		<span class="keyword">if</span> (ipvs-&gt;backup_tinfo)</span><br><span class="line">			<span class="keyword">goto</span> out_early;</span><br><span class="line"></span><br><span class="line">		ipvs-&gt;bcfg = *c;</span><br><span class="line">		name = <span class="string">&quot;ipvs-b:%d:%d&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 设置线程调用函数 */</span></span><br><span class="line">		threadfn = sync_thread_backup;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* 出错 */</span></span><br><span class="line"></span><br><span class="line">		result = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> out_early;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (state == IP_VS_STATE_MASTER) &#123;</span><br><span class="line">		<span class="comment">/* 主机初始化同步数据，设置线程唤醒函数 */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">ipvs_master_sync_state</span> *<span class="title">ms</span>;</span></span><br><span class="line"></span><br><span class="line">		result = -ENOMEM;</span><br><span class="line">		ipvs-&gt;ms = kcalloc(count, <span class="keyword">sizeof</span>(ipvs-&gt;ms[<span class="number">0</span>]), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!ipvs-&gt;ms)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		ms = ipvs-&gt;ms;</span><br><span class="line">		<span class="keyword">for</span> (id = <span class="number">0</span>; id &lt; count; id++, ms++) &#123;</span><br><span class="line">			<span class="comment">/* 初始化每个线程的ipvs_master_sync_state */</span></span><br><span class="line">			INIT_LIST_HEAD(&amp;ms-&gt;sync_queue);</span><br><span class="line">			ms-&gt;sync_queue_len = <span class="number">0</span>;</span><br><span class="line">			ms-&gt;sync_queue_delay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 初始化ms-&gt;master_wakeup_work，设置ms-&gt;master_wakeup_work-&gt;work-&gt;func = master_wakeup_work_handler，master_wakeup_work_handler会被放到system_wq内被</span></span><br><span class="line"><span class="comment">			延迟调度 */</span></span><br><span class="line">			INIT_DELAYED_WORK(&amp;ms-&gt;master_wakeup_work,</span><br><span class="line">					  master_wakeup_work_handler);</span><br><span class="line">			ms-&gt;ipvs = ipvs;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	result = -ENOMEM;</span><br><span class="line">	ti = kcalloc(count, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_thread_data),</span><br><span class="line">		     GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!ti)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (id = <span class="number">0</span>; id &lt; count; id++) &#123;</span><br><span class="line">		<span class="comment">/* 为每个线程初始化对应的socket和相关数据，并创建线程 */</span></span><br><span class="line"></span><br><span class="line">		tinfo = &amp;ti[id];</span><br><span class="line">		tinfo-&gt;ipvs = ipvs;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 如果是备机，为buf分配内存用于接收主机的同步数据 */</span></span><br><span class="line">		<span class="keyword">if</span> (state == IP_VS_STATE_BACKUP) &#123;</span><br><span class="line">			result = -ENOMEM;</span><br><span class="line">			tinfo-&gt;buf = kmalloc(ipvs-&gt;bcfg.sync_maxlen,</span><br><span class="line">					     GFP_KERNEL);</span><br><span class="line">			<span class="keyword">if</span> (!tinfo-&gt;buf)</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		tinfo-&gt;id = id;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 为主机或备机生成对应socket，每个线程都有一个对应的socket，其绑定的端口为8848 + id */</span></span><br><span class="line">		<span class="keyword">if</span> (state == IP_VS_STATE_MASTER)</span><br><span class="line">			result = make_send_sock(ipvs, id, dev, &amp;tinfo-&gt;sock);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			result = make_receive_sock(ipvs, id, dev, &amp;tinfo-&gt;sock);</span><br><span class="line">		<span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 创建并启动线程 */</span></span><br><span class="line">		task = kthread_run(threadfn, tinfo, name, ipvs-&gt;gen, id);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(task)) &#123;</span><br><span class="line">			result = PTR_ERR(task);</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* 该task会被master_wakeup_work_handler执行 */</span></span><br><span class="line">		tinfo-&gt;task = task;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 保存线程数据，设置同步状态*/</span></span><br><span class="line">	<span class="keyword">if</span> (state == IP_VS_STATE_MASTER)</span><br><span class="line">		ipvs-&gt;master_tinfo = ti;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ipvs-&gt;backup_tinfo = ti;</span><br><span class="line">	spin_lock_bh(&amp;ipvs-&gt;sync_buff_lock);</span><br><span class="line">	ipvs-&gt;sync_state |= state;</span><br><span class="line">	spin_unlock_bh(&amp;ipvs-&gt;sync_buff_lock);</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;ipvs-&gt;sync_mutex);</span><br><span class="line">	rtnl_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/* 错误处理，关闭线程并清理数据 */</span></span><br><span class="line">	rtnl_unlock();</span><br><span class="line">	id = min(id, count - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (ti) &#123;</span><br><span class="line">		<span class="keyword">for</span> (tinfo = ti + id; tinfo &gt;= ti; tinfo--) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tinfo-&gt;task)</span><br><span class="line">				kthread_stop(tinfo-&gt;task);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!(ipvs-&gt;sync_state &amp; IP_VS_STATE_MASTER)) &#123;</span><br><span class="line">		kfree(ipvs-&gt;ms);</span><br><span class="line">		ipvs-&gt;ms = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;ipvs-&gt;sync_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 释放socket */</span></span><br><span class="line">	<span class="keyword">if</span> (ti) &#123;</span><br><span class="line">		<span class="keyword">for</span> (tinfo = ti + id; tinfo &gt;= ti; tinfo--) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tinfo-&gt;sock)</span><br><span class="line">				sock_release(tinfo-&gt;sock);</span><br><span class="line">			kfree(tinfo-&gt;buf);</span><br><span class="line">		&#125;</span><br><span class="line">		kfree(ti);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 减少模块使用计数 */</span></span><br><span class="line">	ip_vs_use_count_dec();</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">out_early:</span><br><span class="line">	mutex_unlock(&amp;ipvs-&gt;sync_mutex);</span><br><span class="line">	rtnl_unlock();</span><br><span class="line"></span><br><span class="line">	ip_vs_use_count_dec();</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ip-vs-sync-conn"><a href="#ip-vs-sync-conn" class="headerlink" title="ip_vs_sync_conn"></a>ip_vs_sync_conn</h4><p>当有流量访问虚服务时，主机会通过ip_vs_sync_conn设置同步数据，随后会在另一个线程中将同步数据发给备机</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">ip_vs_sync_conn</span><span class="params">(<span class="keyword">struct</span> netns_ipvs *ipvs, <span class="keyword">struct</span> ip_vs_conn *cp, <span class="type">int</span> pkts)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_mesg</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">ip_vs_sync_conn</span> *<span class="title">s</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_buff</span> *<span class="title">buff</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipvs_master_sync_state</span> *<span class="title">ms</span>;</span></span><br><span class="line">	<span class="type">int</span> id;</span><br><span class="line">	__u8 *p;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> len, pe_name_len, pad;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 存在疑问，什么样的包是ONE_PACKET */</span></span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;flags &amp; IP_VS_CONN_F_ONE_PACKET)</span><br><span class="line">		<span class="keyword">goto</span> control;</span><br><span class="line">sloop:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 判断当前的连接是否符合会话同步的条件，涉及到相关全局配置 */</span></span><br><span class="line">	<span class="keyword">if</span> (!ip_vs_sync_conn_needed(ipvs, cp, pkts))</span><br><span class="line">		<span class="keyword">goto</span> control;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 检查参数合法性 */</span></span><br><span class="line">	pe_name_len = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;pe_data_len) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!cp-&gt;pe_data || !cp-&gt;dest) &#123;</span><br><span class="line">			IP_VS_ERR_RL(<span class="string">&quot;SYNC, connection pe_data invalid\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pe_name_len = strnlen(cp-&gt;pe-&gt;name, IP_VS_PENAME_MAXLEN);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_lock_bh(&amp;ipvs-&gt;sync_buff_lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 验证是否是主机 */</span></span><br><span class="line">	<span class="keyword">if</span> (!(ipvs-&gt;sync_state &amp; IP_VS_STATE_MASTER)) &#123;</span><br><span class="line">		spin_unlock_bh(&amp;ipvs-&gt;sync_buff_lock);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 利用threads_mask选取一个线程id，下面的代码就是准备这个线程需要发送的数据 */</span></span><br><span class="line">	id = select_master_thread_id(ipvs, cp);</span><br><span class="line">	ms = &amp;ipvs-&gt;ms[id];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* struct ip_vs_sync_v4就是备机用来建立连接表项的数据，下面设置len的长度，</span></span><br><span class="line"><span class="comment">	这决定了最终发送的同步数据的大小 */</span></span><br><span class="line">	len = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_v4);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;flags &amp; IP_VS_CONN_F_SEQ_MASK)</span><br><span class="line">		len += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_conn_options) + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;pe_data_len)</span><br><span class="line">		len += cp-&gt;pe_data_len + <span class="number">2</span>;	<span class="comment">/* + Param hdr field */</span></span><br><span class="line">	<span class="keyword">if</span> (pe_name_len)</span><br><span class="line">		len += pe_name_len + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	pad = <span class="number">0</span>;</span><br><span class="line">	buff = ms-&gt;sync_buff;</span><br><span class="line">	<span class="keyword">if</span> (buff) &#123;</span><br><span class="line">		<span class="comment">/* buff不为空，表明之前已有要发送的数据，此时还没来得及发送 */</span></span><br><span class="line"></span><br><span class="line">		m = buff-&gt;mesg;</span><br><span class="line">		pad = (<span class="number">4</span> - (<span class="type">size_t</span>) buff-&gt;head) &amp; <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (buff-&gt;head + len + pad &gt; buff-&gt;end || m-&gt;reserved) &#123;</span><br><span class="line">			<span class="comment">/* 之前的buffer剩余空间不够容纳此次的数据，于是将之前保存的buffer添加到队列内</span></span><br><span class="line"><span class="comment">			并将ms-&gt;sync_buff置空，用于保存下一次的同步数据。当一次流量过多时，</span></span><br><span class="line"><span class="comment">			队列的作用会更明显 */</span></span><br><span class="line">			sb_queue_tail(ipvs, ms);</span><br><span class="line">			ms-&gt;sync_buff = <span class="literal">NULL</span>;</span><br><span class="line">			buff = <span class="literal">NULL</span>;</span><br><span class="line">			pad = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!buff) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* ms-&gt;sync_buff为空，需要新分配一个buffer用于传递这次的数据 */</span></span><br><span class="line">		buff = ip_vs_sync_buff_create(ipvs, len);</span><br><span class="line">		<span class="keyword">if</span> (!buff) &#123;</span><br><span class="line">			spin_unlock_bh(&amp;ipvs-&gt;sync_buff_lock);</span><br><span class="line">			pr_err(<span class="string">&quot;ip_vs_sync_buff_create failed.\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		ms-&gt;sync_buff = buff;</span><br><span class="line">		m = buff-&gt;mesg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 下面便是填充连接相关的数据 */</span></span><br><span class="line">	p = buff-&gt;head;</span><br><span class="line">	buff-&gt;head += pad + len;</span><br><span class="line">	m-&gt;size = htons(ntohs(m-&gt;size) + pad + len);</span><br><span class="line">	<span class="keyword">while</span> (pad--)</span><br><span class="line">		*(p++) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	s = (<span class="keyword">union</span> ip_vs_sync_conn *)p;</span><br><span class="line"></span><br><span class="line">	s-&gt;v4.type = (cp-&gt;af == AF_INET6 ? STYPE_F_INET6 : <span class="number">0</span>);</span><br><span class="line">	s-&gt;v4.ver_size = htons(len &amp; SVER_MASK);	<span class="comment">/* Version 0 */</span></span><br><span class="line">	s-&gt;v4.flags = htonl(cp-&gt;flags &amp; ~IP_VS_CONN_F_HASHED);</span><br><span class="line">	s-&gt;v4.state = htons(cp-&gt;state);</span><br><span class="line">	s-&gt;v4.protocol = cp-&gt;protocol;</span><br><span class="line">	s-&gt;v4.cport = cp-&gt;cport;</span><br><span class="line">	s-&gt;v4.vport = cp-&gt;vport;</span><br><span class="line">	s-&gt;v4.dport = cp-&gt;dport;</span><br><span class="line">	s-&gt;v4.fwmark = htonl(cp-&gt;fwmark);</span><br><span class="line">	s-&gt;v4.timeout = htonl(cp-&gt;timeout / HZ);</span><br><span class="line">	m-&gt;nr_conns++;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		p += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_v4);	<span class="comment">/* options ptr */</span></span><br><span class="line">		s-&gt;v4.caddr = cp-&gt;caddr.ip;</span><br><span class="line">		s-&gt;v4.vaddr = cp-&gt;vaddr.ip;</span><br><span class="line">		s-&gt;v4.daddr = cp-&gt;daddr.ip;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;flags &amp; IP_VS_CONN_F_SEQ_MASK) &#123;</span><br><span class="line">		*(p++) = IPVS_OPT_SEQ_DATA;</span><br><span class="line">		*(p++) = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_conn_options);</span><br><span class="line">		hton_seq((<span class="keyword">struct</span> ip_vs_seq *)p, &amp;cp-&gt;in_seq);</span><br><span class="line">		p += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_seq);</span><br><span class="line">		hton_seq((<span class="keyword">struct</span> ip_vs_seq *)p, &amp;cp-&gt;out_seq);</span><br><span class="line">		p += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_seq);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;pe_data_len &amp;&amp; cp-&gt;pe_data) &#123;</span><br><span class="line">		*(p++) = IPVS_OPT_PE_DATA;</span><br><span class="line">		*(p++) = cp-&gt;pe_data_len;</span><br><span class="line">		<span class="built_in">memcpy</span>(p, cp-&gt;pe_data, cp-&gt;pe_data_len);</span><br><span class="line">		p += cp-&gt;pe_data_len;</span><br><span class="line">		<span class="keyword">if</span> (pe_name_len) &#123;</span><br><span class="line">			*(p++) = IPVS_OPT_PE_NAME;</span><br><span class="line">			*(p++) = pe_name_len;</span><br><span class="line">			<span class="built_in">memcpy</span>(p, cp-&gt;pe-&gt;name, pe_name_len);</span><br><span class="line">			p += pe_name_len;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_unlock_bh(&amp;ipvs-&gt;sync_buff_lock);</span><br><span class="line"></span><br><span class="line">control:</span><br><span class="line">	<span class="comment">/* 同步当前连接的controller，一般就是指持久化模板，这里判断如果当前连接被持久化</span></span><br><span class="line"><span class="comment">	模板控制就会把持久化模板一起同步到备机 */</span></span><br><span class="line">	cp = cp-&gt;control;</span><br><span class="line">	<span class="keyword">if</span> (!cp)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (cp-&gt;flags &amp; IP_VS_CONN_F_TEMPLATE)</span><br><span class="line">		pkts = atomic_add_return(<span class="number">1</span>, &amp;cp-&gt;in_pkts);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		pkts = sysctl_sync_threshold(ipvs);</span><br><span class="line">	<span class="keyword">goto</span> sloop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="sync-thread-master"><a href="#sync-thread-master" class="headerlink" title="sync_thread_master"></a>sync_thread_master</h4><p>主机会创建一个线程调用此方法向备机发送同步数据，同步数据通过<code>ip_vs_local_request4-&gt;ip_vs_in-&gt;ip_vs_sync_conn</code>被填充</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sync_thread_master</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_thread_data</span> *<span class="title">tinfo</span> =</span> data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netns_ipvs</span> *<span class="title">ipvs</span> =</span> tinfo-&gt;ipvs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipvs_master_sync_state</span> *<span class="title">ms</span> =</span> &amp;ipvs-&gt;ms[tinfo-&gt;id];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> tinfo-&gt;sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_buff</span> *<span class="title">sb</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 从ms-&gt;sync_queue队列内或ms-&gt;sync_buff内取得要发送的数据 */</span></span><br><span class="line">		sb = next_sync_buff(ipvs, ms);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(kthread_should_stop()))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!sb) &#123;</span><br><span class="line">			<span class="comment">/* 暂时没有需要发送的数据 */</span></span><br><span class="line">			schedule_timeout(IPVS_SYNC_CHECK_PERIOD);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 通过ip_vs_send_sync_msg向备机发送同步数据，如果进入这个函数可以看到其调用了ip_vs_send_async，</span></span><br><span class="line"><span class="comment">		发送的数据为sb-&gt;mesg，大小为sb-&gt;mesg-&gt;size，但实际上sb-&gt;mesg-&gt;size会大于sizeof(struct ip_vs_sync_mesg)，</span></span><br><span class="line"><span class="comment">		这是因为sb-&gt;mesg-&gt;size在ip_vs_sync_conn中被加上了sizeof(struct ip_vs_sync_v4)和一些头部数据，这就会把我们在ip_vs_sync_conn填充的ip_vs_sync_v4数据一同发送给备机 */</span></span><br><span class="line">		<span class="keyword">while</span> (ip_vs_send_sync_msg(tinfo-&gt;sock, sb-&gt;mesg) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 等待直到socket可写或当前线程要终止 */</span></span><br><span class="line">			__wait_event_interruptible(*sk_sleep(sk),</span><br><span class="line">						   sock_writeable(sk) ||</span><br><span class="line">						   kthread_should_stop());</span><br><span class="line">			<span class="keyword">if</span> (unlikely(kthread_should_stop()))</span><br><span class="line">				<span class="keyword">goto</span> done;</span><br><span class="line">		&#125;</span><br><span class="line">		ip_vs_sync_buff_release(sb);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">	<span class="comment">/* 线程终止，清理数据 */</span></span><br><span class="line">	__set_current_state(TASK_RUNNING);</span><br><span class="line">	<span class="keyword">if</span> (sb)</span><br><span class="line">		ip_vs_sync_buff_release(sb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((sb = sb_dequeue(ipvs, ms)))</span><br><span class="line">		ip_vs_sync_buff_release(sb);</span><br><span class="line">	__set_current_state(TASK_RUNNING);</span><br><span class="line"></span><br><span class="line">	sb = get_curr_sync_buff(ipvs, ms, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sb)</span><br><span class="line">		ip_vs_sync_buff_release(sb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sync-thread-backup"><a href="#sync-thread-backup" class="headerlink" title="sync_thread_backup"></a>sync_thread_backup</h4><p>备机新建一个线程用于接收主机发来的数据，并将其送往<code>ip_vs_process_message</code>处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sync_thread_backup</span><span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_thread_data</span> *<span class="title">tinfo</span> =</span> data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netns_ipvs</span> *<span class="title">ipvs</span> =</span> tinfo-&gt;ipvs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> tinfo-&gt;sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">udp_sock</span> *<span class="title">up</span> =</span> udp_sk(sk);</span><br><span class="line">	<span class="type">int</span> len;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (!kthread_should_stop()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 等待，直到有数据到来或当前线程要终止 */</span></span><br><span class="line">		wait_event_interruptible(*sk_sleep(sk),</span><br><span class="line">					 !skb_queue_empty_lockless(&amp;sk-&gt;sk_receive_queue) ||</span><br><span class="line">					 !skb_queue_empty_lockless(&amp;up-&gt;reader_queue) ||</span><br><span class="line">					 kthread_should_stop());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (!skb_queue_empty_lockless(&amp;sk-&gt;sk_receive_queue) ||</span><br><span class="line">		       !skb_queue_empty_lockless(&amp;up-&gt;reader_queue)) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 从主机接受数据 */</span></span><br><span class="line">			len = ip_vs_receive(tinfo-&gt;sock, tinfo-&gt;buf,</span><br><span class="line">					ipvs-&gt;bcfg.sync_maxlen);</span><br><span class="line">			<span class="keyword">if</span> (len &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (len != -EAGAIN)</span><br><span class="line">					pr_err(<span class="string">&quot;receiving message error\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 处理主机发送过来的同步数据 */</span></span><br><span class="line">			ip_vs_process_message(ipvs, tinfo-&gt;buf, len);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ip-vs-process-message"><a href="#ip-vs-process-message" class="headerlink" title="ip_vs_process_message"></a>ip_vs_process_message</h4><p><code>ip_vs_process_message</code>负责校验从主机发送过来的数据，同时对符合条件的连接调用<code>ip_vs_proc_sync_conn</code>新建或更新连接状态</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ip_vs_process_message</span><span class="params">(<span class="keyword">struct</span> netns_ipvs *ipvs, __u8 *buffer,</span></span><br><span class="line"><span class="params">				  <span class="type">const</span> <span class="type">size_t</span> buflen)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_sync_mesg</span> *<span class="title">m2</span> =</span> (<span class="keyword">struct</span> ip_vs_sync_mesg *)buffer;</span><br><span class="line">	__u8 *p, *msg_end;</span><br><span class="line">	<span class="type">int</span> i, nr_conns;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 基本数据大小校验 */</span></span><br><span class="line">	<span class="keyword">if</span> (buflen &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_mesg_v0)) &#123;</span><br><span class="line">		IP_VS_DBG(<span class="number">2</span>, <span class="string">&quot;BACKUP, message header too short\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (buflen != ntohs(m2-&gt;size)) &#123;</span><br><span class="line">		IP_VS_DBG(<span class="number">2</span>, <span class="string">&quot;BACKUP, bogus message size\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* 校验syncid，仅当主机的syncid和自身的syncid相同时才同步 */</span></span><br><span class="line">	<span class="keyword">if</span> (ipvs-&gt;bcfg.syncid != <span class="number">0</span> &amp;&amp; m2-&gt;syncid != ipvs-&gt;bcfg.syncid) &#123;</span><br><span class="line">		IP_VS_DBG(<span class="number">7</span>, <span class="string">&quot;BACKUP, Ignoring syncid = %d\n&quot;</span>, m2-&gt;syncid);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* 处理1版本的信息，1为默认版本 */</span></span><br><span class="line">	<span class="keyword">if</span> ((m2-&gt;version == SYNC_PROTO_VER) &amp;&amp; (m2-&gt;reserved == <span class="number">0</span>)</span><br><span class="line">	    &amp;&amp; (m2-&gt;spare == <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* msg_end这里就指向struct ip_vs_sync_mesg的结尾，union ip_vs_sync_conn的开头 */</span></span><br><span class="line">		msg_end = buffer + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> ip_vs_sync_mesg);</span><br><span class="line">		nr_conns = m2-&gt;nr_conns;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;nr_conns; i++) &#123;</span><br><span class="line">			<span class="comment">/* 依据从主机接收到的连接数更新或新建一条连接到本地 */</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> <span class="title">ip_vs_sync_conn</span> *<span class="title">s</span>;</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">			<span class="type">int</span> retc;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 校验size合法性，同时将s指向当前连接 */</span></span><br><span class="line">			p = msg_end;</span><br><span class="line">			<span class="keyword">if</span> (p + <span class="keyword">sizeof</span>(s-&gt;v4) &gt; buffer+buflen) &#123;</span><br><span class="line">				IP_VS_ERR_RL(<span class="string">&quot;BACKUP, Dropping buffer, too small\n&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			s = (<span class="keyword">union</span> ip_vs_sync_conn *)p;</span><br><span class="line">			size = ntohs(s-&gt;v4.ver_size) &amp; SVER_MASK;</span><br><span class="line">			msg_end = p + size;</span><br><span class="line">			<span class="keyword">if</span> (msg_end  &gt; buffer+buflen) &#123;</span><br><span class="line">				IP_VS_ERR_RL(<span class="string">&quot;BACKUP, Dropping buffer, msg &gt; buffer\n&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (ntohs(s-&gt;v4.ver_size) &gt;&gt; SVER_SHIFT) &#123;</span><br><span class="line">				IP_VS_ERR_RL(<span class="string">&quot;BACKUP, Dropping buffer, Unknown version %d\n&quot;</span>,</span><br><span class="line">					      ntohs(s-&gt;v4.ver_size) &gt;&gt; SVER_SHIFT);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 调用ip_vs_proc_sync_conn更新或新建一个连接项到连接表内 */</span></span><br><span class="line">			retc = ip_vs_proc_sync_conn(ipvs, p, msg_end);</span><br><span class="line">			<span class="keyword">if</span> (retc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				IP_VS_ERR_RL(<span class="string">&quot;BACKUP, Dropping buffer, Err: %d in decoding\n&quot;</span>,</span><br><span class="line">					     retc);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 对齐 */</span></span><br><span class="line">			msg_end = p + ((size + <span class="number">3</span>) &amp; ~<span class="number">3</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ip-vs-proc-conn"><a href="#ip-vs-proc-conn" class="headerlink" title="ip_vs_proc_conn"></a>ip_vs_proc_conn</h4><p>备机通过<code>ip_vs_proc_sync_conn</code>处理option和pe，最终通过<code>ip_vs_proc_sync_conn-&gt;ip_vs_proc_conn</code>新建或更新一个连接，以实现和主机的连接表的同步</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ip_vs_proc_conn</span><span class="params">(<span class="keyword">struct</span> netns_ipvs *ipvs, <span class="keyword">struct</span> ip_vs_conn_param *param,</span></span><br><span class="line"><span class="params">			    <span class="type">unsigned</span> <span class="type">int</span> flags, <span class="type">unsigned</span> <span class="type">int</span> state,</span></span><br><span class="line"><span class="params">			    <span class="type">unsigned</span> <span class="type">int</span> protocol, <span class="type">unsigned</span> <span class="type">int</span> type,</span></span><br><span class="line"><span class="params">			    <span class="type">const</span> <span class="keyword">union</span> nf_inet_addr *daddr, __be16 dport,</span></span><br><span class="line"><span class="params">			    <span class="type">unsigned</span> <span class="type">long</span> timeout, __u32 fwmark,</span></span><br><span class="line"><span class="params">			    <span class="keyword">struct</span> ip_vs_sync_conn_options *opt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_dest</span> *<span class="title">dest</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_vs_conn</span> *<span class="title">cp</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; IP_VS_CONN_F_TEMPLATE)) &#123;</span><br><span class="line">		<span class="comment">/* 需要同步的连接为一个普通连接 */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 首先尝试从本地连接表内获取连接，获取的依据为cport、caddr、vport、vaddr、af、</span></span><br><span class="line"><span class="comment">		protocol、ipvs等字段的对比，而不会比较daddr和dport */</span></span><br><span class="line">		cp = ip_vs_conn_in_get(param);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cp &amp;&amp; ((cp-&gt;dport != dport) ||</span><br><span class="line">			   !ip_vs_addr_equal(cp-&gt;daf, &amp;cp-&gt;daddr, daddr))) &#123;</span><br><span class="line">			<span class="comment">/* 如果获取到了连接，但当前连接和需要同步的连接的目的ip或目的端口不同，</span></span><br><span class="line"><span class="comment">			表明需要更新这条连接的信息 */</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!(flags &amp; IP_VS_CONN_F_INACTIVE)) &#123;</span><br><span class="line">				<span class="comment">/* 需要同步的连接为正常连接，为了更新本地连接，这里先让本地连接过期 */</span></span><br><span class="line"></span><br><span class="line">				ip_vs_conn_expire_now(cp);</span><br><span class="line">				__ip_vs_conn_put(cp);</span><br><span class="line">				cp = <span class="literal">NULL</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">/* 需要同步的连接是是一个过期连接，不需要同步，直接return */</span></span><br><span class="line">				__ip_vs_conn_put(cp);</span><br><span class="line">				kfree(param-&gt;pe_data);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* 需要同步一个持久化连接，尝试从本地持久化模板获取连接 */</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 同样的，在获取一个持久化连接时，并不会比较其daddr和dport */</span></span><br><span class="line">		cp = ip_vs_ct_in_get(param);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cp) &#123;</span><br><span class="line">		<span class="comment">/* 成功从本地持久化模板得到连接 或 本地连接的目的端口和目的ip无需更新 */</span></span><br><span class="line">		kfree(param-&gt;pe_data);</span><br><span class="line"></span><br><span class="line">		dest = cp-&gt;dest;</span><br><span class="line">		spin_lock_bh(&amp;cp-&gt;lock);</span><br><span class="line">		<span class="keyword">if</span> ((cp-&gt;flags ^ flags) &amp; IP_VS_CONN_F_INACTIVE &amp;&amp;</span><br><span class="line">		    !(flags &amp; IP_VS_CONN_F_TEMPLATE) &amp;&amp; dest) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 更新活跃连接计数 */</span></span><br><span class="line">			<span class="keyword">if</span> (flags &amp; IP_VS_CONN_F_INACTIVE) &#123;</span><br><span class="line">				<span class="type">atomic_dec</span>(&amp;dest-&gt;activeconns);</span><br><span class="line">				<span class="type">atomic_inc</span>(&amp;dest-&gt;inactconns);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">atomic_inc</span>(&amp;dest-&gt;activeconns);</span><br><span class="line">				<span class="type">atomic_dec</span>(&amp;dest-&gt;inactconns);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 更新flags */</span></span><br><span class="line">		flags &amp;= IP_VS_CONN_F_BACKUP_UPD_MASK;</span><br><span class="line">		flags |= cp-&gt;flags &amp; ~IP_VS_CONN_F_BACKUP_UPD_MASK;</span><br><span class="line">		cp-&gt;flags = flags;</span><br><span class="line">		spin_unlock_bh(&amp;cp-&gt;lock);</span><br><span class="line">		<span class="keyword">if</span> (!dest)</span><br><span class="line">			<span class="comment">/* 绑定实服务器 */</span></span><br><span class="line">			ip_vs_try_bind_dest(cp);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* 本地没有这样的连接，为了实现同步则需要新建一个连接 */</span></span><br><span class="line"></span><br><span class="line">		rcu_read_lock();</span><br><span class="line">		dest = ip_vs_find_dest(ipvs, type, type, daddr, dport,</span><br><span class="line">				       param-&gt;vaddr, param-&gt;vport, protocol,</span><br><span class="line">				       fwmark, flags);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 新建连接并绑定相关参数 */</span></span><br><span class="line">		cp = ip_vs_conn_new(param, type, daddr, dport, flags, dest,</span><br><span class="line">				    fwmark);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		<span class="keyword">if</span> (!cp) &#123;</span><br><span class="line">			kfree(param-&gt;pe_data);</span><br><span class="line">			IP_VS_DBG(<span class="number">2</span>, <span class="string">&quot;BACKUP, add new conn. failed\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; IP_VS_CONN_F_TEMPLATE))</span><br><span class="line">			kfree(param-&gt;pe_data);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 更新其他相关的连接信息 */</span></span><br><span class="line">	<span class="keyword">if</span> (opt) &#123;</span><br><span class="line">		<span class="comment">/* 更新option */</span></span><br><span class="line">		cp-&gt;in_seq = opt-&gt;in_seq;</span><br><span class="line">		cp-&gt;out_seq = opt-&gt;out_seq;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_set</span>(&amp;cp-&gt;in_pkts, sysctl_sync_threshold(ipvs));</span><br><span class="line">	cp-&gt;state = state;</span><br><span class="line">	cp-&gt;old_state = cp-&gt;state;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">		<span class="comment">/* 更新或设置超时时间 */</span></span><br><span class="line">		<span class="keyword">if</span> (timeout &gt; MAX_SCHEDULE_TIMEOUT / HZ)</span><br><span class="line">			timeout = MAX_SCHEDULE_TIMEOUT / HZ;</span><br><span class="line">		cp-&gt;timeout = timeout*HZ;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* 设置默认超时时间 */</span></span><br><span class="line">		<span class="keyword">struct</span> ip_vs_proto_data *pd;</span><br><span class="line"></span><br><span class="line">		pd = ip_vs_proto_data_get(ipvs, protocol);</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; IP_VS_CONN_F_TEMPLATE) &amp;&amp; pd &amp;&amp; pd-&gt;timeout_table)</span><br><span class="line">			cp-&gt;timeout = pd-&gt;timeout_table[state];</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			cp-&gt;timeout = (<span class="number">3</span>*<span class="number">60</span>*HZ);</span><br><span class="line">	&#125;</span><br><span class="line">	ip_vs_conn_put(cp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag"># 源码分析</a>
              <a href="/tags/lvs/" rel="tag"># lvs</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/11/05/%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/" rel="prev" title="内存对齐">
                  <i class="fa fa-angle-left"></i> 内存对齐
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/12/01/keepalived%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="next" title="keepalived源码分析">
                  keepalived源码分析 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Aaron Zhao</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">21k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:15</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
